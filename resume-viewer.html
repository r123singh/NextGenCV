<!--  -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Viewer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.0.0/github-markdown.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <meta name="supabase-url" content="">
    <meta name="supabase-key" content="">
    <style>
        .markdown-body {
            box-sizing: border-box;
            min-width: 200px;
            max-width: 980px;
            margin: 0 auto;
            padding: 45px;
        }

        @media (max-width: 768px) {
            .markdown-body {
                padding: 15px;
            }
        }

        .button-container {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #0066cc;
            color: white;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            text-decoration: none;
        }

        .button:hover {
            background-color: #0052a3;
        }

        .export-menu {
            position: absolute;
            right: 0;
            margin-top: 8px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }

        .export-menu a {
            display: block;
            padding: 8px 16px;
            color: #333;
            text-decoration: none;
        }

        .export-menu a:hover {
            background-color: #f5f5f5;
        }
    </style>
</head>

<body>
    <div class="markdown-body">
        <h1>Your Resume generated by ResumeX <i class="fa-solid fa-check-circle" style="color: green;"></i></h1>
        <div class="button-container">
            <button class="button" onclick="copyToClipboard()">
                <i class="fa-solid fa-copy"></i> Copy
            </button>
            <button class="button" onclick="downloadResume()">
                <i class="fa-solid fa-download"></i> Download
            </button>
            <button class="button" onclick="closeTab()">
                <i class="fa-solid fa-xmark"></i> Close Tab
            </button>
            <div style="position: relative;">
                <button class="button" onclick="toggleExportMenu()">
                    <i class="fa-solid fa-file-export"></i> Export
                </button>
                <div id="exportMenu" class="export-menu">
                    <a href="#" onclick="exportAsPDF()">
                        <i class="fa-solid fa-file-pdf"></i> Export as PDF
                    </a>
                    <a href="#" onclick="exportAsDOCX()">
                        <i class="fa-solid fa-file-word"></i> Export as DOCX
                    </a>
                    <a href="#" onclick="exportAsDOC()">
                        <i class="fa-solid fa-file-word"></i> Export as DOC
                    </a>
                    <a href="#" onclick="exportAsTXT()">
                        <i class="fa-solid fa-file-lines"></i> Export as TXT
                    </a>
                    <a href="#" onclick="exportAsHTML()">
                        <i class="fa-solid fa-file-code"></i> Export as HTML
                    </a>
                </div>
            </div>
        </div>
        <div id="resume-content"></div>

    </div>
    <script>
        let parsedMarkdown = null;
        
        // Initialize Supabase in production
        const isProduction = window.location.hostname !== 'localhost' && 
                           window.location.hostname !== '127.0.0.1';
        
        let supabase;
        if (isProduction) {
            const supabaseUrl = document.querySelector('meta[name="supabase-url"]')?.content;
            const supabaseKey = document.querySelector('meta[name="supabase-key"]')?.content;
            
            if (supabaseUrl && supabaseKey) {
                supabase = supabase.createClient(supabaseUrl, supabaseKey);
            } else {
                console.error('Supabase configuration is incomplete');
            }
        }

        // Get the URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const fileUrl = urlParams.get('url');
        
        async function fetchResumeContent() {
            try {
                if (!fileUrl) {
                    console.error('No URL provided');
                    alert('No resume URL provided');
                    return;
                }

                // Use the direct Supabase URL
                const response = await fetch(fileUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const content = await response.text();
                
                if (content) {
                    parsedMarkdown = content;
                    document.getElementById('resume-content').innerHTML = marked.parse(content);
                } else {
                    alert('No resume content found');
                }
            } catch (err) {
                console.error('Error fetching resume:', err);
                alert('Error fetching resume: ' + err.message);
            }
        }

        // Fetch resume content when page loads
        fetchResumeContent();

      
        function copyToClipboard() {
            if (parsedMarkdown) {
                navigator.clipboard.writeText(parsedMarkdown)
                    .then(() => alert('Resume copied to clipboard!'))
                    .catch(err => console.error('Error copying to clipboard:', err));
            }
        }

        function downloadResume() {
            if (parsedMarkdown) {
                const blob = new Blob([parsedMarkdown], { type: 'text/markdown' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'resume.md';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }
        }

        function closeTab() {
            window.close();
        }

        function toggleExportMenu() {
            const menu = document.getElementById('exportMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        // Export functions
        async function exportAsPDF() {
            const element = document.getElementById('resume-content');
            const opt = {
                margin: 1,
                filename: 'resume.pdf',
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            await html2pdf().set(opt).from(element).save();
        }

        function exportAsDOCX() {

            alert('DOCX export coming soon!');
        }

        function exportAsDOC() {
            // Add DOC export logic
            alert('DOC export coming soon!');
        }

        function exportAsTXT() {
            if (parsedMarkdown) {
                const blob = new Blob([parsedMarkdown], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'resume.txt';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }
        }

        function exportAsHTML() {
            if (parsedMarkdown) {
                const htmlContent = marked.parse(parsedMarkdown);
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'resume.html';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }
        }

        // Close export menu when clicking outside
        document.addEventListener('click', function(event) {
            const exportMenu = document.getElementById('exportMenu');
            const exportButton = event.target.closest('.button');
            if (!exportButton && exportMenu.style.display === 'block') {
                exportMenu.style.display = 'none';
            }
        });
    </script>
</body>

</html>